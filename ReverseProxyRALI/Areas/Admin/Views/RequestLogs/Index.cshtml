@model IEnumerable<FGate.Data.Entities.RequestLog>
@{
    ViewData["Title"] = "Logs de Solicitudes";
    int totalPages = (int)ViewData["TotalPages"];
    int currentPage = (int)ViewData["CurrentPage"];
    string searchQuery = ViewData["SearchQuery"] as string;
}

<div class="d-flex justify-content-between align-items-center mb-3">
</div>
<p class="text-muted">Mostrando las solicitudes más recientes procesadas por el proxy. Los logs se guardan automáticamente.</p>
<div class="card card-body mb-4">
    <form asp-action="Index" method="get" class="row g-3 align-items-end">
        <div class="col-md-4">
            <label class="form-label">Búsqueda General</label>
            <input type="text" name="searchQuery" class="form-control" placeholder="Ruta, IP..." value="@ViewData["SearchQuery"]">
        </div>
        <div class="col-md-2">
            <label class="form-label">Método</label>
            <select name="httpMethod" class="form-select">
                <option value="">Todos</option>
                <option value="GET" selected="@("GET".Equals(ViewData["CurrentHttpMethod"] as string))">GET</option>
                <option value="POST" selected="@("POST".Equals(ViewData["CurrentHttpMethod"] as string))">POST</option>
                <option value="PUT" selected="@("PUT".Equals(ViewData["CurrentHttpMethod"] as string))">PUT</option>
                <option value="DELETE" selected="@("DELETE".Equals(ViewData["CurrentHttpMethod"] as string))">DELETE</option>
                <option value="PATCH" selected="@("PATCH".Equals(ViewData["CurrentHttpMethod"] as string))">PATCH</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Estado</label>
            <select name="statusCodeFamily" class="form-select">
                <option value="">Todos</option>
                <option value="2xx" selected="@("2xx".Equals(ViewData["CurrentStatusCodeFamily"] as string))">2xx Éxito</option>
                <option value="4xx" selected="@("4xx".Equals(ViewData["CurrentStatusCodeFamily"] as string))">4xx Error Cliente</option>
                <option value="5xx" selected="@("5xx".Equals(ViewData["CurrentStatusCodeFamily"] as string))">5xx Error Servidor</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Desde</label>
            <input type="date" name="startDate" class="form-control" value="@ViewData["CurrentStartDate"]">
        </div>
        <div class="col-md-2">
            <label class="form-label">Hasta</label>
            <input type="date" name="endDate" class="form-control" value="@ViewData["CurrentEndDate"]">
        </div>
        <div class="col-12 text-end">
            <a asp-action="Index" class="btn btn-secondary"><i class="bi bi-x"></i> Limpiar Filtros</a>
            <button class="btn btn-primary" type="submit"><i class="bi bi-funnel-fill"></i> Filtrar</button>
        </div>
    </form>
</div>

<div class="table-responsive">
    <table class="table table-sm table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th><i class="bi bi-clock"></i> Timestamp (UTC)</th>
                <th>Método</th>
                <th>Ruta</th>
                <th><i class="bi bi-shield-lock"></i> Cód. Estado</th>
                <th><i class="bi bi-stopwatch"></i> Duración (ms)</th>
                <th><i class="bi bi-pc-display-horizontal"></i> IP Cliente</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var log in Model)
            {
                <tr>
                    <td>@log.TimestampUtc.ToString("yyyy-MM-dd HH:mm:ss.fff")</td>
                    <td><span class="badge bg-info text-dark">@log.HttpMethod</span></td>
                    <td class="text-break">@log.RequestPath</td>
                    <td>
                        <span class="badge @(log.ResponseStatusCode >= 500 ? "bg-danger" : (log.ResponseStatusCode >= 400 ? "bg-warning text-dark" : "bg-success"))">
                            @log.ResponseStatusCode
                        </span>
                    </td>
                    <td>@log.DurationMs</td>
                    <td><code>@log.ClientIpAddress</code></td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (totalPages > 1)
{
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <a class="page-link" asp-action="Index"
                   asp-route-page="@(currentPage - 1)"
                   asp-route-searchQuery="@searchQuery"
                   asp-route-httpMethod="@ViewData["CurrentHttpMethod"]"
                   asp-route-statusCodeFamily="@ViewData["CurrentStatusCodeFamily"]"
                   asp-route-startDate="@ViewData["CurrentStartDate"]"
                   asp-route-endDate="@ViewData["CurrentEndDate"]">Anterior</a>
            </li>
            @for (int i = 1; i <= totalPages; i++)
            {
                <li class="page-item @(i == currentPage ? "active" : "")">
                    <a class="page-link" asp-action="Index"
                       asp-route-page="@i"
                       asp-route-searchQuery="@searchQuery"
                       asp-route-httpMethod="@ViewData["CurrentHttpMethod"]"
                       asp-route-statusCodeFamily="@ViewData["CurrentStatusCodeFamily"]"
                       asp-route-startDate="@ViewData["CurrentStartDate"]"
                       asp-route-endDate="@ViewData["CurrentEndDate"]">@i</a>
                </li>
            }
            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <a class="page-link" asp-action="Index"
                   asp-route-page="@(currentPage + 1)"
                   asp-route-searchQuery="@searchQuery"
                   asp-route-httpMethod="@ViewData["CurrentHttpMethod"]"
                   asp-route-statusCodeFamily="@ViewData["CurrentStatusCodeFamily"]"
                   asp-route-startDate="@ViewData["CurrentStartDate"]"
                   asp-route-endDate="@ViewData["CurrentEndDate"]">Siguiente</a>
            </li>
        </ul>
    </nav>
}
